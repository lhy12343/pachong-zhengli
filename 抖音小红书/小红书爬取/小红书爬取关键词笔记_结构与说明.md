# 小红书爬取关键词笔记.py — 结构与作用说明（方案A）

本文档总结 `抖音小红书/小红书爬取/小红书爬取关键词笔记.py` 的文件定位、结构组成、运行流程、关键参数与规则，并给出技术实现难度与爬虫级别评估。

---

## 一、文件定位（概述）
- 目标：在保持登录态的真实浏览器环境下，进行关键词搜索与数据抓取，批量进入笔记详情页，解析并下载文本、图片与视频。
- 核心思路：
  - 使用 Selenium 启动 Chrome，并通过 `chrome_user_data/` 持久化登录状态；
  - 借助 CDP 性能日志捕获真实请求头（Cookie、x-s、x-t、traceid 等）用于 API 请求或校验；
  - 同时集成详情页抓取与下载（图片/视频），支持并发与限速。

---

## 二、代码结构（模块/类/关键方法）

- 类：`XHSIntegratedCrawler`
  - 作用：负责浏览器启动、登录保持、UI 搜索触发、CDP 抓包提取请求头、请求与解析的上游协作。
  - 关键方法：
    - `_setup_browser()`：配置并启动 Chrome（用户数据目录、日志抑制、性能日志开启）。
    - `_ensure_login()` / `_is_logged_in_ui()`：检测/等待登录成功（仅依赖 UI 元素存在性规则）。
    - `_perform_search_via_ui(keyword)`：通过页面元素输入关键词触发站内搜索（保留同源流程）。
    - `_extract_headers_from_browser()`：提取 Cookie 与真实 UA，构建基础请求头；与 `last_signed_headers` 结合使用。
    - `_make_api_request()`：在提取到真实头的前提下发起 API 请求（可选）。
    - `_extract_token_id_pairs(node)`：递归提取 `xsec_token` 与 `id` 对（用于链接组装/校验）。
    - `_extract_master_streams_from_text(text)`：从源码/JSON中提取 `masterUrl`/`backupUrls`/`streamType`。
    - `_select_video_urls_by_rules(streams)`：对提取的清晰度集合应用下载规则（说明见下文）。
    - `get_selected_video_urls_from_page()`：基于 `driver.page_source` 返回应下载的视频 URL 列表。

- 类：`XHSDetailDownloader`
  - 作用：面向详情页的解析与保存；下载文本、图片与视频（并发+限速）。
  - 关键方法：
    - `_fetch_html(url)`：请求详情页 HTML。
    - `_parse_title(html)` / `_parse_author(html)` / `_parse_text_and_images(html)`：解析标题、作者、正文与图片。
    - `_parse_video_urls(html)`：用正则从 HTML 中提取 `"masterUrl"`（含转义处理）。
    - `_download_images_concurrent(urls, folder)` / `_download_videos_concurrent(urls, folder)`：并发下载资源，失败标记。
    - `_select_best_video_url(candidates)`：单视频兜底选择（不做网络探测）。
    - `_scrape_one(url)`：抓取单条详情页，整合解析与下载逻辑（见“视频选择规则”）。

- 运行入口
  - `run_interactive()`：交互式运行，完成登录检查、请求头提取、关键词搜索、结果分页与批量详情抓取。
  - `main()`：程序入口。

---

## 三、运行流程（高层视图）
1. 启动浏览器 `_setup_browser()`，指定 `chrome_user_data/` 持久化登录态。
2. 执行 `_ensure_login()`：若未登录，引导手动登录并轮询检测。
3. UI 触发搜索 `_perform_search_via_ui()`，同时通过性能日志捕获关键请求与签名头。
4. 获取搜索结果链接集合，交由 `XHSDetailDownloader.scrape_many()` 并发抓取。
5. 在 `_scrape_one()` 内：
   - 请求详情页 HTML。
   - 解析标题/作者/文本/图片；图片并发下载（可开关）。
   - 解析视频 `masterUrl` 集合，按规则筛选后并发下载（可开关）。
   - 保存到以笔记标题命名的目录中。

---

## 四、关键配置与参数
- 浏览器配置：`chrome_user_data/` 用户数据目录；多项 `--disable-*` 降噪与稳定设置；启用性能日志 `includeExtraInfo`。
- 并发与限速：`max_workers`（默认建议10）、`rate_per_sec`（默认建议50）。
- 下载开关：`dl_images=True`、`dl_videos=True`。

---

## 五、视频选择规则（重要）
- 解析来源：
  - `_parse_video_urls(html)`：直接从详情页 HTML 的 `"masterUrl"` 字段提取；
  - 或通过 `get_selected_video_urls_from_page()`：基于 `driver.page_source` 提取 `streams` 后选择。
- 规则实现（以 `_scrape_one()` 的实际下载逻辑为准）：
  - 多个且包含“`_259`”时：只下载所有不包含“`_259`”的链接；
  - 多个且不包含“`_259`”时：全部下载；
  - 仅一个时：直接下载；
  - “`_259`”判定已收紧为仅匹配带下划线的形式（避免误判 query/ID 中的“259”）。
- 备注：过去的“130优先”策略已移除，不再使用。

---

## 六、使用方法（最小步骤）
1. 运行脚本，首次按提示完成登录；再次运行可复用登录状态。
2. 在交互中输入关键词、并发与限速参数、是否仅抓取前 N 条用于测试。
3. 等待抓取完成，结果保存于同目录下以“`笔记（标题）`”命名的文件夹。

---

## 七、技术实现难度评估
- 难度：中等偏上（6.5/10）。
- 难点：
  - 浏览器持久化登录状态管理与可靠检测；
  - CDP 性能日志解析与 `*ExtraInfo` 事件组合以获取完整请求头；
  - 解析 `masterUrl`/`backupUrls`/`streamType` 并做多清晰度的业务化选择；
  - 并发下载与速率限制、错误重试处理；
  - 页面结构/字段命名变化的兼容性。
- 稳定性策略：
  - Selenium 真机环境规避复杂逆向签名；
  - 去重保序、异常捕获与兼容性正则；
  - 用户数据目录持久化减少频繁登录带来的不确定性。

---

## 八、爬虫级别评估
- 级别：中级工程化爬虫（向高级靠拢）。
- 理由：
  - 具备登录保持、抓包提头、并发抓取、资源下载等完整能力链路；
  - 通过真实浏览器规避复杂签名逆向，整体对抗性适中；
  - 已有多清晰度下载策略与限速控制，但尚未引入更强的网络拦截/自动化异常恢复/分布式调度等高级特性。

---

## 九、注意事项与扩展建议
- 若 `_parse_video_urls()` 未解析到有效链接，可回退使用 `get_selected_video_urls_from_page()` 的 streams 解析路径。
- 如需更强健：
  - 补充网络抓包级的清晰度识别（基于响应体/Content-Length 对比）；
  - 为下载器加入镜像源回退（利用 `backupUrls`）；
  - 增强日志与指标（解析成功率、下载成功率、重试次数、耗时统计）。

---

文档版本：v1.0（2025-08-17）
