# pachong —— 爬虫学习与工程实践合集（工程化详版）

本仓库汇集了从入门到实战的多类爬虫脚本与案例，覆盖 requests/正则/并发/selenium/CDP 抓包、文件下载与解析等能力，并提供可直接运行的“小红书关键词脚本”。

> 最近更新：2025-08-17

---

## 一、功能清单（按目录模块）

- `01_第一章_爬虫入门/`：requests 基础、HTTP 请求与响应、简单解析示例
- `02_第二章_数据解析/`：正则/BeautifulSoup/JSON/CSV 解析，图像样例
- `03_进阶/`：登录与 cookie、代理、防盗链等
- `04_多线程/`：多线程批量下载与文本抓取（西游记等示例）
- `05_selenium入门/`：Selenium 基本操作、元素定位与事件
- `抖音小红书/小红书爬取/`：
  - 文件：`小红书爬取关键词笔记.py`、`小红书爬取关键词笔记_结构与说明.md`
  - 功能：关键词搜索、（基于浏览器会话思路的）登录态、CDP 抓包、详情页解析、图片/视频并发下载
- `抖音小红书/抖音搜索关键词批量视频抓取下载/`：抖音关键词抓取与下载相关脚本与导出
- `全国建筑市场监督公共服务平台/`：加密分析、企业数据采集脚本
- `实战训练/`：PDF 文本批量提取、公共资源交易数据抓取

---

## 二、环境与依赖

- Python：3.12.2
- 浏览器：Google Chrome（与 chromedriver 版本匹配）
- 主要三方包：
  - `selenium`, `requests`, `urllib3`, `tqdm`, `beautifulsoup4`（如有使用）
- 系统要求：Windows（已在 Windows 下验证）

> 注：`抖音小红书/小红书爬取/` 使用 `chrome_user_data/` 持久化登录态；首次需手动登录一次。

---

## 三、快速开始

1) 创建与激活虚拟环境
```powershell
python -m venv .venv
. .venv\Scripts\Activate.ps1
python -m pip install -U pip
```

2) 一键安装锁定依赖（推荐）
```powershell
pip install -r requirements.txt
```

3) 国内镜像加速（可选）
- 临时使用：
```powershell
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```
- 持久配置：
```powershell
pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
pip config set install.trusted-host pypi.tuna.tsinghua.edu.cn
```

4) 运行示例脚本
- 入门练习：`01_第一章_爬虫入门/01_第一个爬虫的开发.py`
- 多线程下载：`04_多线程/1.多线程.py`
- 小红书关键词脚本：`抖音小红书/小红书爬取/小红书爬取关键词笔记.py`
  - 首次运行会打开 Chrome 完成登录；登录后会话保存在 `chrome_user_data/`

5) 常见安装问题排查
- SSL/证书报错：升级 pip 并使用镜像源重试；必要时添加 `--trusted-host`。
- 构建/编译失败：确保已安装 VC 运行库；或使用镜像源提供的预编译轮子。
- 依赖冲突：
  ```powershell
  pip uninstall -y -r requirements.txt; pip cache purge; pip install -r requirements.txt
  ```
- Chrome 驱动不匹配：更新本机 Chrome 或使用 Selenium Manager 自动下载匹配驱动。

---

## 四、目录结构总览（节选）

```
pachong/
├─ 01_第一章_爬虫入门/
├─ 02_第二章_数据解析/
├─ 03_进阶/
├─ 04_多线程/
├─ 05_selenium入门/
├─ 抖音小红书/
│  ├─ 小红书爬取/
│  │  ├─ 小红书爬取关键词笔记.py
│  │  └─ 小红书爬取关键词笔记_结构与说明.md
│  └─ 抖音搜索关键词批量视频抓取下载/
├─ 全国建筑市场监督公共服务平台/
└─ 实战训练/
```

---

## 五、项目地图（模块用途与可复现性）

- **`01_第一章_爬虫入门/`**：入门示例；依赖轻；可复现性高。
- **`02_第二章_数据解析/`**：正则/CSV/JSON/图片示例；少量数据样本；可复现性高。
- **`03_进阶/`**：登录、代理、防盗链；对目标站点依赖较强；可复现性中。
- **`04_多线程/`**：并发下载、批量文本抓取；对网络与目标站点稳定性有依赖；可复现性中。
- **`05_selenium入门/`**：Selenium 基础操作；浏览器与驱动需匹配；可复现性高。
- **`抖音小红书/小红书爬取/`**：
  - `小红书爬取关键词笔记.py`（关键词→详情并发下载）。详见：`小红书爬取关键词笔记_结构与说明.md`。
  - 可复现性：高（依赖真实浏览器登录与会话持久化）。
- **`全国建筑市场监督公共服务平台/`**：包含加密分析与数据抓取；目标站点变更可能影响复现；可复现性中。
- **`实战训练/`**：PDF 提取与数据抓取样例；依赖第三方数据源；可复现性中。

---

## 六、核心特性与技术设计

- **Selenium 持久化登录**：
  - 通过 `--user-data-dir=chrome_user_data/` 持久化浏览器会话，实现“一次登录、长期可用”。
  - 登录检测：基于 UI 元素检查，未登录则引导手动登录。

- **CDP 抓包与真实请求头复用**：
  - 启用性能日志，捕获 `Network.requestWillBeSent` 与 `Network.responseReceivedExtraInfo` 等事件，提取 Cookie、UA、`x-s/x-t/x-s-common/traceid`。
  - 对于小红书等站点，可复用浏览器生成的签名，规避复杂逆向。

- **详情页解析与并发下载**：
  - 解析标题、作者、正文、图片与视频 masterUrl。
  - 并发下载与速率限制（如 `max_workers=10`、`rate_per_sec=50`）。
  - 视频多清晰度选择规则：
    - 多个且包含 `_259`：仅下载非 `_259` 链接；
    - 多个且不含 `_259`：全部下载；
    - 仅一个：直接下载；
    - `_259` 判定收紧为仅匹配带下划线的形式，避免误判。

- **健壮性**：
  - 失败重试、结果去重、异常捕获、兼容性正则。
  - 对于站点字段变动，提供解析与选择逻辑的回退路径（如 `backupUrls`）。

---

## 七、使用示例（以小红书为例）

1) 启动并登录
```powershell
python "抖音小红书/小红书爬取/小红书Selenium集成方案.py"
```
- 首次运行手动登录，小窗口提示完成登录后继续。

2) 交互式抓取
- 按提示输入关键词、并发度、速率、是否下载图片/视频等。
- 结果保存至同目录的以笔记标题命名的文件夹中。

3) 仅获取请求头（可选）
- 代码提供从浏览器会话中抽取真实请求头的能力，可用于其他脚本复用。

---

## 八、运行手册（小红书）

- **首次运行（登录）**：
  1. 运行 `抖音小红书/小红书爬取/小红书爬取关键词笔记.py`；
  2. 弹出 Chrome 后完成登录；
  3. 登录成功后脚本检测通过，后续会话将保存在 `chrome_user_data/`。

- **关键词抓取 → 详情并发下载**：
  1. 交互输入关键词、并发数（如 10）、速率限制（如 50/s）、是否下载图片/视频；
  2. 程序抓取搜索结果链接并进入详情页；
  3. 解析标题/作者/正文/图片，提取视频 `masterUrl`；
  4. 按规则下载视频：多个含`_259`→仅非`_259`；多个不含`_259`→全部；仅一个→直接下载。

- **回退路径**：
  - 若页面结构变动导致未解析到视频，可启用 `backupUrls` 或回退到基于 `driver.page_source` 的 streams 解析。
  - 对象字段命名变化时，使用兼容性正则与容错逻辑。

- **延伸阅读**：
  - 规则与实现详解见：`抖音小红书/小红书爬取/小红书爬取关键词笔记_结构与说明.md`。

---

## 九、常见问题（FAQ）与排错

- **登录态失效/访问 404**：确保使用 `chrome_user_data/` 并重新登录；小红书详情页未登录状态下会 404。
- **406 与签名问题**：CDP 抓包生成的 `x-s/x-t/x-s-common` 更可靠；自行伪造易失败。
- **驱动不匹配**：更新 chromedriver 版本与 Chrome 对齐；可使用 Selenium Manager 自动下载。
- **下载失败/速度过慢**：调低并发与速率；网络波动时允许重试；对 `_259` 规则留意是否正确过滤。

---

## Cookie 获取声明

> 本项目不提供任何网站的账号、Cookie、请求头等登录或认证信息。请您根据所在地区法律法规与目标网站的用户协议，自行完成登录并获取所需信息。

- 如需为抖音功能生成 `cookies.json`，可使用脚本：
  - 路径：`抖音小红书/抖音搜索关键词批量视频抓取下载/生成_douyin_cookies_selenium.py`
  - 运行示例：
    ```powershell
    python 抖音小红书/抖音搜索关键词批量视频抓取下载/生成_douyin_cookies_selenium.py --no-headless
    ```
  - 输出：同目录生成 `cookies.json`（结构为 `{ "cookies": [...] }`），与 `抖音.py` 的注入逻辑兼容。
- 小红书相关脚本使用 `chrome_user_data/` 持久化登录，请在本地完成登录后再使用。
- 使用本项目仅限学习与研究用途，切勿用于任何违反平台条款与法律的行为。

---

## 十、合规与隐私

- **数据合规**：仅用于学习研究，不得用于违反平台条款或法律的用途。
- **隐私保护**：不提交任何个人 Cookie、账号、令牌、浏览器用户数据；
- **再分发**：若包含第三方代码/素材，请保留其原始协议与署名；在 `THIRD_PARTY.md` 说明来源与许可。

---

