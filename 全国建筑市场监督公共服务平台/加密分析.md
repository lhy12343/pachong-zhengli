# 全国建筑市场监督公共服务平台加密分析

## 已发现的关键信息

### 1. 请求头中的accessToken
```
accessToken: jkFXxgu9TcpocIyCKmJ+tfpxe/45B9dbWMUXhdY7vLVF0gyrgAJuZjKhaBBH4h/JhpUUKvcMtoMqfGfwdLCb8g==
```

### 2. 关键JavaScript代码位置
文件：app.b226da26.js

#### axios实例配置：
```javascript
value: function() {
    var t = {
        baseURL: this.baseUrl,
        headers: {
            timeout: 3e4,
            v: h,
            accessToken: o["a"].state.accessToken || ""
        }
    };
    return t
}
```

#### token存储机制：
```javascript
SET_TOKEN: function(t, e) {
    e ? (t.accessToken = e,
    localStorage.setItem("accessToken", e)) : (t.accessToken = "",
    localStorage.clear("accessToken"))
}
```

#### token获取：
```javascript
c["a"].commit("SET_TOKEN", n.accessToken)
```
其中`n`是`startCaptcha`接口的返回数据。

## 完整的认证和加密流程

### 1. 验证码初始化流程
```javascript
Object(i["i"])()  // 调用startCaptcha接口
.then(function(t) {
    var e = t.data
      , n = e.randomId
      , r = e.gt
      , o = e.challenge
      , s = e.success
      , l = e.session_key;
    initGeetest({  // 初始化极验验证码
        gt: r,
        challenge: o,
        offline: !s,
        new_captcha: !0,
        product: "bind"
    }, function(t) {
        t.onReady(function() {
            c["a"].state.captcha = t
        }).onSuccess(function() {
            var e = t.getValidate();
            // 验证码验证成功后调用verifyLoginCode接口
            Object(i["j"])(Object(a["a"])({}, e, {
                randomId: n,
                session_key: l
            })).then(function(t) {
                var e = t.success
                  , n = t.data;
                e && (c["a"].commit("SET_TOKEN", n.accessToken),  // 设置accessToken
                void 0 !== c["a"].state.captcha.callback && c["a"].state.captcha.callback()),
                c["a"].state.captcha.reset()
            })
        }).onError(function() {})
    })
})
```

### 2. 请求和响应加密机制

#### 响应数据解密：
- **算法**：AES-CBC-PKCS7
- **密钥**：`Dt8j9wGw%6HbxfFn`
- **IV**：`0123456789ABCDEF`
- **流程**：
  1. 将十六进制字符串解析为字节数据
  2. 将字节数据转换为Base64格式
  3. 使用AES-CBC-PKCS7算法解密
  4. 将结果解析为UTF-8字符串

#### 请求头中的accessToken：
- 通过Geetest验证码验证后获得
- 存储在localStorage中
- 每次请求都会自动添加到请求头

## Python实现解密

### 1. 安装依赖
```bash
pip install pycryptodome
```

### 2. 解密代码
```python
import json
import base64
import binascii
from Crypto.Cipher import AES
from Crypto.Util.Padding import unpad

def decrypt_response(encrypted_data):
    """
    解密全国建筑市场监督公共服务平台的响应数据
    
    Args:
        encrypted_data (str): 从服务器获取的十六进制加密数据
        
    Returns:
        dict: 解密后的JSON数据
    """
    # 加密参数
    key = "Dt8j9wGw%6HbxfFn".encode('utf-8')  # 16字节密钥
    iv = "0123456789ABCDEF".encode('utf-8')   # 16字节IV
    
    try:
        # 1. 将十六进制字符串解析为字节数据
        hex_data = binascii.unhexlify(encrypted_data)
        
        # 2. 使用AES-CBC-PKCS7算法解密
        cipher = AES.new(key, AES.MODE_CBC, iv)
        decrypted = cipher.decrypt(hex_data)
        
        # 3. 去除PKCS7填充
        unpadded = unpad(decrypted, AES.block_size)
        
        # 4. 将结果解析为UTF-8字符串
        json_str = unpadded.decode('utf-8')
        
        # 5. 解析为JSON对象
        return json.loads(json_str)
        
    except Exception as e:
        print(f"解密失败: {e}")
        return None
```

### 3. 认证流程
要获取有效的accessToken，需要完成Geetest验证码验证流程：
1. 调用`/geetest/startCaptcha`获取验证参数
2. 完成Geetest验证码验证
3. 调用`/geetest/verifyLoginCode`获取accessToken
4. 将accessToken添加到后续请求的请求头中